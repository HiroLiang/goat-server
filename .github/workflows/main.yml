name: Deploy Goat-Server to GCP VM

on:
  push:
    branches: [ main, feature/dev ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      GO_VERSION: "1.25.0"
      GCP_VM_NAME: "goat-server"
      GCP_ZONE: "asia-east1-a"

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Go environment
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.0'

      - name: Set deployment environments
        run: |
          if [ "${GITHUB_REF##*/}" = "main" ]; then 
            echo "DEPLOY_DIR=/home/hiroliang/goat-server" >> $GITHUB_ENV
            echo "SERVICE_NAME=goat-server" >> $GITHUB_ENV
          else
            echo "DEPLOY_DIR=/home/hiroliang/goat-dev-server" >> $GITHUB_ENV
            echo "SERVICE_NAME=goat-dev-server" >> $GITHUB_ENV
          fi
          echo "BRANCH=${GITHUB_REF##*/}" >> $GITHUB_ENV

      - name: Compile and build binary
        run: |
          mkdir -p bin
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -o bin/goat-api cmd/api/main.go

      - name: Show binary file info
        run: file bin/goat-api || true

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v3
        with:
          version: '>= 363.0.0'

      - name: Deploy to GCP VM
        run: |
          echo "Deploying ${SERVICE_NAME} to ${DEPLOY_DIR}"
          gcloud compute scp bin/goat-api \
            hiroliang@${GCP_VM_NAME}:${DEPLOY_DIR}/ \
            --zone=${GCP_ZONE} --tunnel-through-iap --quiet

          gcloud compute ssh hiroliang@${GCP_VM_NAME} \
            --zone=${GCP_ZONE} --tunnel-through-iap --quiet \
            --command="sudo systemctl daemon-reload && sudo systemctl restart ${SERVICE_NAME} && sudo systemctl status ${SERVICE_NAME} --no-pager"
          
          echo "Deployment complete for ${SERVICE_NAME} on ${BRANCH}"
